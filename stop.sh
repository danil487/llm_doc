#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }

COMPOSE_CMD=""
if docker compose version &> /dev/null; then
    COMPOSE_CMD="docker compose"
elif docker-compose version &> /dev/null; then
    COMPOSE_CMD="docker-compose"
else
    echo "‚ùå Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo ""
echo "============================================"
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
echo "============================================"
echo ""

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
for arg in "$@"; do
    case $arg in
        --clean|-c)
            echo ""
            log_warning "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ:"
            echo "   ‚Ä¢ –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ ChromaDB (–≤—Å–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)"
            echo "   ‚Ä¢ –ö—ç—à –º–æ–¥–µ–ª–µ–π HuggingFace"
            echo "   ‚Ä¢ –î–∞–Ω–Ω—ã–µ Redis (–∏—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π)"
            echo "   ‚Ä¢ Docker –æ–±—Ä–∞–∑—ã"
            echo ""
            echo "   –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 8+ —á–∞—Å–æ–≤!"
            echo ""
            read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ –î–ê –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm
            if [ "$confirm" != "–î–ê" ] && [ "$confirm" != "–¥–∞" ] && [ "$confirm" != "yes" ] && [ "$confirm" != "y" ]; then
                log_info "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                exit 0
            fi
            log_info "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö..."
            $COMPOSE_CMD down --remove-orphans --volumes --rmi all
            log_success "–°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞"
            exit 0
            ;;
        --down|-d)
            # ‚úÖ –£–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –Ω–æ –°–û–•–†–ê–ù–Ø–ï–¢ volumes (–¥–∞–Ω–Ω—ã–µ)
            log_info "–ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª—è—é—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –°–û–•–†–ê–ù–Ø–Æ–¢–°–Ø)..."
            $COMPOSE_CMD down --remove-orphans
            log_success "–°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (volumes —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)"
            exit 0
            ;;
    esac
done

# ‚úÖ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –º—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (stop, –Ω–µ remove)
log_info "–ú—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)..."
$COMPOSE_CMD stop
log_success "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo ""
echo "üìã –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: ./stop.sh --down"
echo "üìã –î–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ./stop.sh --clean"
echo ""
# docker/Dockerfile.prebuilt
# –ü—Ä–µ–¥—Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏

FROM python:3.11-slim-bookworm AS base

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    jq \
    libgl1 \
    libglib2.0-0 \
    wget \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º requirements –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫—ç—à–∞
RUN mkdir -p /app/.cache /app/data/chroma_db /app/logs

# ‚úÖ –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê: Embedding –º–æ–¥–µ–ª—å (–∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ ~/.cache)
RUN python3 -c "
from sentence_transformers import SentenceTransformer
print('üîß –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embedding –º–æ–¥–µ–ª–∏...')
model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2', device='cpu')
print('‚úÖ Embedding –º–æ–¥–µ–ª—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞')
"

# ‚úÖ –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê: Reranker –º–æ–¥–µ–ª—å
RUN python3 -c "
from sentence_transformers import CrossEncoder
print('üîß –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ reranker –º–æ–¥–µ–ª–∏...')
model = CrossEncoder('cross-encoder/ms-marco-MiniLM-L-6-v2', device='cpu')
print('‚úÖ Reranker –º–æ–¥–µ–ª—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞')
"

# ‚úÖ –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê: –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –¥–ª—è truncation
RUN python3 -c "
from transformers import AutoTokenizer
print('üîß –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞...')
tokenizer = AutoTokenizer.from_pretrained('gpt2', local_files_only=False)
print('‚úÖ –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω')
"

# –ö–æ–ø–∏—Ä—É–µ–º entrypoint
COPY docker/entrypoint.sh /entrypoint.sh
COPY scripts/wait-for.sh /wait-for.sh
RUN chmod +x /entrypoint.sh /wait-for.sh

EXPOSE 8000
ENV PYTHONPATH=/app
ENV HF_HOME=/app/.cache
ENV TRANSFORMERS_CACHE=/app/.cache

# Healthcheck –¥–ª—è –æ–±—Ä–∞–∑–∞
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python3 -c "from hybrid_search.database import Database; Database().collection.count()" || exit 1

ENTRYPOINT ["/entrypoint.sh"]